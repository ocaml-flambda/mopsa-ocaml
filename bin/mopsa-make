#!/bin/bash

function usage() {
    echo "Mopsa wrapper for make"
    echo "Usage: mopsa-make [options] [make-target]"
    echo "Options:"
    echo " -h, --help                           display this message"
    echo " -C DIRECTORY, --directory DIRECTORY  change directory to DIRECTORY before compiling."
    echo " -t TARGET, --target TARGET           analyze binary TARGET. (default: [make-target])"
    echo " -d DEBUG, --debug DEBUG              activate then debug channels DEBUG during the analysis. (default: none)"
    echo " -o DB, --db DB                       save build database in DB. (default: mopsa.db)"
}

MOPSADIR="$(cd "$(dirname "$0")" && pwd -P)/.."

OPTIND=1

opts=$(getopt --longoptions "help,directory:,target:,debug:,db:" --options "hC:t:d:o:" -- "$@")

DIRECTORY="."
DB="mopsa.db"
DEBUG=""

eval set --$opts

while true; do
    case "$1" in
        -h | --help)
            usage ; exit ; shift
            ;;
        -C | --directory )
            DIRECTORY="$2"; shift 2;
            ;;
        -t | --target )
            MOPSA_TARGET="$2"; shift 2;
            ;;
        -d | --debug)
            DEBUG="$2"; shift 2
            ;;
        -o | --db)
            DB="$2"; shift 2
            ;;
        -- )
            MAKE_TARGET="$2"; shift 2;
            break
            ;;
        * )
            break
            ;;
    esac
done

if [ ! -d "${DIRECTORY}" ] ; then
    echo "${DIRECTORY} is not a directory";
    exit 1
fi

if [[ "${MAKE_TARGET}" == "clean" ]]; then
    make -C ${DIRECTORY} ${MAKE_TARGET}
else
    if [[ "${MOPSA_TARGET}" == "" ]]; then
        MOPSA_TARGET=${MAKE_TARGET}
    fi
    PATH=${MOPSADIR}/parsers/c/bin:${PATH} MOPSADB=${DB} make -C ${DIRECTORY} ${MAKE_TARGET}
    ERROR=$?
    if [[ ${ERROR} -eq 0 ]]; then
        echo "${MOPSADIR}/bin/mopsa-c -make-target=${MOPSA_TARGET} -debug=${DEBUG} ${DB}"
        ${MOPSADIR}/bin/mopsa-c -make-target=${MOPSA_TARGET} -debug=${DEBUG} ${DB}
    fi
fi
